<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BaityBait</title>
    <style>
      html {
        background-color: #111;
        color: #eee;
      }
      * {
        font-family: Inter, Roobert, 'Helvetica Neue', Helvetica, Arial, sans-serif;
        padding: 0;
        margin: 0;
      }

      thead tr > * {
        text-align: center;
        height: 2em;
        border: solid 1px #9047ff;
        padding: 0;
        margin: 0;
      }

      tbody tr td {
        font-size: 11px;
        margin-top: 1em;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5em;
      }

      tbody tr td span {
        padding: 0.5em 1em;
        background-color: #555;
        border-radius: 0.5em;
      }

      tr:nth-child(odd) {
        background-color: #111;
      }

      tr:nth-child(even) {
        background-color: #222;
      }

      .d-none {
        display: none;
      }

      .d-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        width: 700px;
        text-align: center;
      }

      .message-container span {
        display: block;
        font-size: 11px;
        padding: 0.3em 0.6em;
        margin: 0.3em 0px;
        background: #555;
        border-radius: 0.5em;
        display: flex;
        align-items: center;
        gap: 0.5em;
      }
      .input {
        margin: 1em 0;
        width: 100%;
        display: block;
        padding: 0.5em 1em;
        border-radius: 0.5em;
        border: solid 1px #666;
      }
    </style>
  </head>
  <body style="margin: 0 auto; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; width: 100vw">
    <h3 style="display: flex; justify-content: center; align-items: center; margin-top: 1em">
      <img src="image.png" style="margin-bottom: 1em; height: 10em; width: 10em" />
    </h3>
    <div class="d-grid" style="grid-template-columns: 6em 1fr auto; gap: 1em; max-width: 33em">
      <input class="input" type="number" placeholder="cant. de participaciones" name="numbershares" value="1" />
      <input name="username" class="input" type="text" placeholder="Nombre del pibe" value="" />
      <div id="add-user" style="margin: 1em 0">
        <button
          id="btn-add-user"
          style="
            cursor: pointer;
            background-color: #9047ff;
            color: #fff;
            text-decoration: none;
            padding: 0.5em 2em;
            border-radius: 0.3em;
            border: none;
            font-weight: 900;
          "
        >
          Agregar participante
        </button>
      </div>
    </div>
    <h1 style="margin-bottom: 1em; text-align: center">
      Participantes: <span id="participantes">0</span> - Puntos totales: <span id="participaciones">0</span>
    </h1>
    <div id="main">
      <div style="display: flex; min-width: 38em; justify-content: space-between">
        <button
          style="
            cursor: pointer;
            border: solid 1px #9047ff;
            color: #9047ff;
            text-decoration: none;
            padding: 0.5em 2em;
            border-radius: 0.3em;
            background: #fff;
            font-weight: 900;
          "
          id="reload-table"
        >
          Actualizar tabla
        </button>
        <button
          style="
            cursor: pointer;
            background-color: #9047ff;
            color: #fff;
            text-decoration: none;
            padding: 0.5em 2em;
            border-radius: 0.3em;
            border: none;
            font-weight: 900;
          "
          id="drop-key"
        >
          Sortear clave
        </button>
      </div>
    </div>
    <div id="winners" class="d-none" style="margin-top: 1em">
      <h2 style="font-weight: 900">Ganador</h2>
      <h2 style="font-weight: 900">Suplente</h2>
    </div>
    <div style="margin: 2em 1em; display: grid; grid-template-columns: 1.4fr 0.6fr; gap: 1em; align-items: start">
      <table style="border-collapse: collapse">
        <thead style="background: #9047ff; color: #fff">
          <tr style="background: #9047ff">
            <th>Participantes</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="1">Aun no hay nadie participando</td>
          </tr>
        </tbody>
      </table>
      <div class="message-container" style="background: #222; padding: 0.4em; border-radius: 1em; border: solid 1px #eee">
        <span>Esperando subs...</span>
      </div>
    </div>
    <script>
      const getHistory = (history) => {
        switch (history.type) {
          case 'prime':
            return `<span><svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4185f3" fill-rule="evenodd" d="M18 5v8a2 2 0 0 1-2 2H4a2.002 2.002 0 0 1-2-2V5l4 3 4-4 4 4 4-3z" clip-rule="evenodd"></path></svg><label><b>${history.username}</b> se subscribi贸 con el prime</label></span>`;
          case 'normal':
            return `<span><svg width="20" height="20" version="1.1" viewBox="0 0 20 20" x="0px" y="0px" data-a-selector="tw-core-button-icon" aria-hidden="true" class="ScIconSVG-sc-1q25cff-1 jpczqG"><g><path fill="#9047ff" d="M8.944 2.654c.406-.872 1.706-.872 2.112 0l1.754 3.77 4.2.583c.932.13 1.318 1.209.664 1.853l-3.128 3.083.755 4.272c.163.92-.876 1.603-1.722 1.132L10 15.354l-3.579 1.993c-.846.47-1.885-.212-1.722-1.132l.755-4.272L2.326 8.86c-.654-.644-.268-1.723.664-1.853l4.2-.583 1.754-3.77z"></path></g></svg><label><b>${history.username}</b> se subscribi贸</label></span>`;
          case 'gift':
            if (history.recipient) {
              return `<span><svg  width="20" height="25" viewBox="0 0 20 20" aria-hidden="true"><path stroke="#00d6d6" stroke-width="1" fill="#028383" fill-rule="evenodd" d="M16 6h2v6h-1v6H3v-6H2V6h2V4.793c0-2.507 3.03-3.762 4.803-1.99.131.131.249.275.352.429L10 4.5l.845-1.268a2.81 2.81 0 0 1 .352-.429C12.969 1.031 16 2.286 16 4.793V6zM6 4.793V6h2.596L7.49 4.341A.814.814 0 0 0 6 4.793zm8 0V6h-2.596l1.106-1.659a.814.814 0 0 1 1.49.451zM16 8v2h-5V8h5zm-1 8v-4h-4v4h4zM9 8v2H4V8h5zm0 4H5v4h4v-4z" clip-rule="evenodd"></path></svg><label><b>${history.username}</b> le regal贸 una sub a <b>${history.recipient}</b></label></span>`;
            }
            return `<span><svg  width="20" height="25" viewBox="0 0 20 20" aria-hidden="true"><path stroke="#00d6d6" stroke-width="1" fill="#028383" fill-rule="evenodd" d="M16 6h2v6h-1v6H3v-6H2V6h2V4.793c0-2.507 3.03-3.762 4.803-1.99.131.131.249.275.352.429L10 4.5l.845-1.268a2.81 2.81 0 0 1 .352-.429C12.969 1.031 16 2.286 16 4.793V6zM6 4.793V6h2.596L7.49 4.341A.814.814 0 0 0 6 4.793zm8 0V6h-2.596l1.106-1.659a.814.814 0 0 1 1.49.451zM16 8v2h-5V8h5zm-1 8v-4h-4v4h4zM9 8v2H4V8h5zm0 4H5v4h4v-4z" clip-rule="evenodd"></path></svg><label><b>${history.username}</b> regal贸 <b>${history.counter}</b> subs</label></span>`;
          default:
            break;
        }
      };

      const reloadTable = () => {
        fetch('/gift-subs/get-messages')
          .then((res) => res.json())
          .then((res) => {
            const tbody = document.querySelector('tbody');
            if (res.history.length) {
              document.querySelector('.message-container').innerHTML = res.history.reduce((acc, history) => acc + getHistory(history), '');
            }
            if (res.participants.length) {
              tbody.innerHTML =
                '<tr><td>' +
                res.participants
                  .sort((a, b) => (b.counter > a.counter ? 1 : -1))
                  .reduce(
                    (acc, participant) =>
                      acc +
                      `<span style="padding: .3em 1em; display: flex; justify-content: space-between; align-items: center;"><span>${participant.username}</span><span style="background: #ddd; padding: .4em 1em; color: black; font-weight: 900;">${participant.counter}</span></span>`,
                    '',
                  ) +
                '</td><td>';
            }
            document.querySelector('#participantes').innerHTML = res.participants.length;
            document.querySelector('#participaciones').innerHTML = res.participants.reduce((acc, e) => acc + e.counter, 0);
          })
          .catch((er) => {
            console.log(er);
          });
      };
      reloadTable();

      document.querySelector('#drop-key').onclick = () => {
        // document.querySelector('#drop-key').remove();
        fetch('/drop-key')
          .then((res) => res.json())
          .then((res) => {
            const arr = [];
            for (let i = 0; i < res.length / 2; i++) {
              arr.push(res[i]);
              arr.push(res[res.length / 2 + i]);
            }
            document.querySelector('#winners').innerHTML += arr.reduce(
              (acc, e, f) =>
                acc +
                (f % 2
                  ? '<div><button style="margin: .5em;border: solid 1px #9047ff; color: #9047ff; text-decoration: none; padding: .5em 2em; border-radius: .3em;background: #fff; font-weight: 900;">' +
                    e +
                    '</button></div>'
                  : '<div><button style="margin: .5em;background-color: #9047ff; color: #fff; text-decoration: none; padding: .5em 2em; border-radius: .3em; border: none;font-weight: 900;">' +
                    e +
                    '</button></div>'),
              '',
            );
            document.querySelector('#winners').classList.remove('d-none');
            document.querySelector('#winners').classList.add('d-grid');
            // document.querySelector('#main').classList.add('d-none');
          })
          .catch((er) => {
            document.querySelector('#winners').innerHTM = err.message;
          });
      };

      document.querySelector('#reload-table').onclick = () => {
        reloadTable();
      };

      document.querySelector('#add-user').onclick = () => {
        document.querySelector('#btn-add-user').innerHTML = 'Cargando...';
        const username = document.querySelector('[name="username"]').value;
        const numbershares = document.querySelector('[name="numbershares"]').value;
        document.querySelector('[name="username"]').value = '';
        fetch(`/add-user?username=${username}&numbershares=${numbershares}`)
          .catch(() => {})
          .finally(() => {
            document.querySelector('#btn-add-user').innerHTML = 'Agregar participante';
            reloadTable();
          });
      };
    </script>
  </body>
</html>
